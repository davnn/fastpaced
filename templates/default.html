<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#7f0000">
    <link rel="manifest" href="/assets/manifest/manifest.json">
    <link rel="alternate" type="application/rss+xml" title="$title$" href="$site$/atom.xml">
    <link rel="canonical" href="$site$$url$">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fastpaced.disqus.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <title>$title$</title>
    <meta name="description" content="$if(abstract)$$abstract$$else$$defaultdescription$$endif$">
    <meta property="og:url" content="$site$$url$">
    <meta property="og:type" content="website">
    <meta property="og:title" content="$title$">
    <meta property="og:site_name" content="fastpaced">
    <meta property="og:description" content="$if(abstract)$$abstract$$else$$defaultdescription$$endif$">
    <meta property="og:image" content="$if(image)$$site$$url$/$image$$else$$site$/assets/images/galaxy.jpg$endif$">
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Blog",
            "@id": "$site$",
            "name": "fastpaced",
            "description": "$defaultdescription$",
            "author": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "creator": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "publisher": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "inLanguage": "en-US"
        }
    </script>
    <script>
        (function () {
            const storageKey = "theme";
            const darkMq = window.matchMedia("(prefers-color-scheme: dark)");
            const saved = localStorage.getItem(storageKey);

            // Decide initial theme before first paint
            const theme = saved ? saved : (darkMq.matches ? "dark" : "light");
            document.documentElement.setAttribute("data-theme", theme);

            // Also keep theme-color consistent for browser UI
            const meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.setAttribute("content", theme === "dark" ? "#c62828" : "#7f0000");
        })();
    </script>
    <style>
        $partial("assets/style.css")$
    </style>
</head>

<body>
    $partial("templates/partials/header.html")$
    <main id="$layout$">
        $body$
    </main>
    <script>
        (function () {
            const KEY = "theme"; // "light" | "dark" | null (System/Auto)
            const root = document.documentElement;
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            const darkMq = window.matchMedia("(prefers-color-scheme: dark)");

            // Grab theme links by ID
            const systemLink = document.getElementById("theme-system");
            const lightLink = document.getElementById("theme-light");
            const darkLink = document.getElementById("theme-dark");
            if (!systemLink || !lightLink || !darkLink) return;

            // --- Helpers -------------------------------------------------------------
            const osTheme = () => (darkMq.matches ? "dark" : "light");
            const getSaved = () => localStorage.getItem(KEY); // "light" | "dark" | null
            const save = (v) => (v ? localStorage.setItem(KEY, v) : localStorage.removeItem(KEY));
            const effective = () => getSaved() || osTheme();

            const applyTheme = (theme) => {
                root.setAttribute("data-theme", theme);
                if (metaTheme)
                    metaTheme.setAttribute("content", theme === "dark" ? "#c62828" : "#7f0000");
            };

            const updateUI = () => {
                const saved = getSaved(); // null = system
                const eff = effective();

                // Bold the active one
                systemLink.style.fontWeight = saved === null ? "bold" : "";
                lightLink.style.fontWeight = saved === "light" ? "bold" : "";
                darkLink.style.fontWeight = saved === "dark" ? "bold" : "";

                // Accessible state
                systemLink.setAttribute("aria-current", saved === null ? "true" : "false");
                lightLink.setAttribute("aria-current", saved === "light" ? "true" : "false");
                darkLink.setAttribute("aria-current", saved === "dark" ? "true" : "false");
            };

            // --- Init ----------------------------------------------------------------
            applyTheme(effective());
            updateUI();

            // Follow OS while in "System"
            const onOSChange = (e) => {
                if (!getSaved()) {
                    applyTheme(e.matches ? "dark" : "light");
                    updateUI();
                }
            };
            darkMq.addEventListener?.("change", onOSChange) ||
                darkMq.addListener(onOSChange); // legacy support

            // --- Click Handlers ------------------------------------------------------
            systemLink.addEventListener("click", (e) => {
                e.preventDefault();
                save(null);
                applyTheme(osTheme());
                updateUI();
            });

            lightLink.addEventListener("click", (e) => {
                e.preventDefault();
                save("light");
                applyTheme("light");
                updateUI();
            });

            darkLink.addEventListener("click", (e) => {
                e.preventDefault();
                save("dark");
                applyTheme("dark");
                updateUI();
            });
        })();
    </script>
</body>
</html>

$partial("templates/partials/footer.html")$