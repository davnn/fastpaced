<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        (function () {
            const KEY = "theme";                 // "light" | "dark" | null (system/auto)
            const saved = localStorage.getItem(KEY);
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const theme = saved || (prefersDark ? "dark" : "light");
            document.documentElement.setAttribute("data-theme", theme);
            document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
        })();
    </script>
    <link rel="manifest" href="/assets/manifest/manifest.json">
    <link rel="alternate" type="application/rss+xml" title="$title$" href="$site$/atom.xml">
    <link rel="canonical" href="$site$$url$">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fastpaced.disqus.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <title>$title$</title>
    <meta name="description" content="$if(abstract)$$abstract$$else$$defaultdescription$$endif$">
    <meta property="og:url" content="$site$$url$">
    <meta property="og:type" content="website">
    <meta property="og:title" content="$title$">
    <meta property="og:site_name" content="fastpaced">
    <meta property="og:description" content="$if(abstract)$$abstract$$else$$defaultdescription$$endif$">
    <meta property="og:image" content="$if(image)$$site$$url$/$image$$else$$site$/assets/images/galaxy.jpg$endif$">
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Blog",
            "@id": "$site$",
            "name": "fastpaced",
            "description": "$defaultdescription$",
            "author": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "creator": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "publisher": {
                "@type": "Person",
                "name": "David Muhr"
            },
            "inLanguage": "en-US"
        }
    </script>
    <style>
        $partial("assets/style.css")$
    </style>
</head>

<body>
    $partial("templates/partials/header.html")$
    <main id="$layout$">
        $body$
    </main>
    <script>
        (function () {
            const KEY = "theme";
            const root = document.documentElement;
            const darkMq = window.matchMedia("(prefers-color-scheme: dark)");

            const links = {
                system: document.getElementById("theme-system"),
                light: document.getElementById("theme-light"),
                dark: document.getElementById("theme-dark"),
            };
            if (!links.system || !links.light || !links.dark) return;

            // --- Helpers -------------------------------------------------------------
            const osTheme = () => (darkMq.matches ? "dark" : "light");
            const getSaved = () => localStorage.getItem(KEY); // "light" | "dark" | null
            const save = (v) => (v ? localStorage.setItem(KEY, v) : localStorage.removeItem(KEY));
            const effective = () => getSaved() || osTheme();

            const applyTheme = (theme) => {
                root.setAttribute("data-theme", theme);
                root.style.colorScheme = theme; // keep controls in sync
            };

            const updateUI = () => {
                const saved = getSaved(); // null = system
                Object.entries(links).forEach(([name, el]) => {
                    const isActive = (name === "system" && saved === null) || saved === name;
                    el.style.fontWeight = isActive ? "bold" : "";
                    el.setAttribute("aria-current", isActive ? "true" : "false");
                });
            };

            const setTheme = (value) => {
                save(value);
                applyTheme(value || osTheme());
                updateUI();
            };

            // --- Init (no duplicate theme set; just sync UI and meta) --------------
            applyTheme(effective()); // needed only to style the links (active)
            updateUI();

            // --- Respond to OS changes while in “system” mode ----------------------
            const onOSChange = (e) => {
                if (!getSaved()) {
                    applyTheme(e.matches ? "dark" : "light");
                    updateUI();
                }
            };
            darkMq.addEventListener?.("change", onOSChange) ||
                darkMq.addListener(onOSChange); // legacy support

            // --- Click Handlers ----------------------------------------------------
            Object.entries(links).forEach(([name, el]) => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    setTheme(name === "system" ? null : name);
                });
            });
        })();
    </script>
</body>

</html>

$partial("templates/partials/footer.html")$